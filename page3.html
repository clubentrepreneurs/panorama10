<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Vidéo + panorama + menu</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link href="https://fonts.cdnfonts.com/css/apex-new" rel="stylesheet">
<style>
html,body{margin:0;overflow:hidden;height:100%;background:none;}
#renderCanvas{width:100%;height:100%;display:block;background:transparent;}
.object-label{position:absolute;color:black;background:rgba(255,255,255,0.7);padding:5px 10px;border-radius:5px;font-family:'Apex New',sans-serif;font-size:18px;white-space:nowrap;transform:translate(-50%,0%);z-index:10;visibility:hidden;cursor:pointer;transition:transform 0.2s ease-in-out,background-color 0.2s ease-in-out;}
@media(min-width:768px){.object-label{font-size:82px;}}
.object-label:hover{transform:translate(-50%,0%) scale(1.05);background-color:rgba(255,255,255,0.9);}
#videoModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:50vw;height:50vh;background:black;z-index:9999;display:none;flex-direction:column;}
#videoModal iframe{width:100%;height:100%;}
#closeVideo{position:absolute;top:5px;right:5px;color:white;font-size:24px;cursor:pointer;z-index:10000;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>

<div id="videoModal">
  <div id="closeVideo">&#x2715;</div>
  <iframe id="ytVideo" src="" frameborder="0" allowfullscreen></iframe>
</div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
<script>
const canvas=document.getElementById("renderCanvas");
const engine=new BABYLON.Engine(canvas,true,{preserveDrawingBuffer:true,stencil:true,alpha:true});
const scene=new BABYLON.Scene(engine);
scene.clearColor=new BABYLON.Color4(0,0,0,0);

const camera=new BABYLON.ArcRotateCamera("cam",Math.PI/2,Math.PI/2,450,new BABYLON.Vector3(0,0,0),scene);
camera.attachControl(canvas,true);
camera.inputs.clear();
new BABYLON.HemisphericLight("light",new BABYLON.Vector3(0,1,0),scene);

const objectLabelMap=new Map();
const radius=400;
const angleIncrement=(2*Math.PI)/3;
const objectLabels=["Réussir sa rentrée","Outils IA d'aide à la réussite","Le laboratoire numérique des compétences"];
const objectLinks=[ "https://www.youtube.com/watch?v=lUU1G-6klpI&list=PLV8G_tL0jD2JNU3NqxIcULusdtMWeKL5k", "https://clubentrepreneurs.github.io/panorama10/page3.html", "https://clubentrepreneurs.github.io/panorama10/page4.html"];

function createPhotoDome(panoFile){
    const dome=new BABYLON.PhotoDome("panorama",panoFile+"?v="+Date.now(),{resolution:32,size:1000},scene);
    dome.imageMode=BABYLON.PhotoDome.MODE_MONOSCOPIC;
    animateCameraSpin();
    const domeMat=dome.mesh.material;
    if(panoFile.endsWith(".jpg")||panoFile.endsWith(".jpeg")){
        domeMat.diffuseTexture.hasAlpha=false;
        domeMat.useAlphaFromDiffuseTexture=false;
        domeMat.transparencyMode=BABYLON.Material.MATERIAL_OPAQUE;
    }else{
        domeMat.diffuseTexture.hasAlpha=true;
        domeMat.useAlphaFromDiffuseTexture=true;
        domeMat.transparencyMode=BABYLON.Material.MATERIAL_ALPHABLEND;
        domeMat.backFaceCulling=false;
        domeMat.needDepthPrePass=true;
    }
}

// --- Création du GIF/vidéo plane ---
const pivot0=new BABYLON.TransformNode("pivot0",scene);
pivot0.rotation.y=0;
const gifPlane=BABYLON.MeshBuilder.CreatePlane("gifPlane",{width:100,height:100},scene);
gifPlane.position.y=-190;
gifPlane.position.z=radius;
gifPlane.parent=pivot0;
const gifMat=new BABYLON.StandardMaterial("gifMat",scene);
const gifTexture=new BABYLON.VideoTexture("gifTex",["focus.mp4"],scene,true,true,BABYLON.VideoTexture.TRILINEAR_SAMPLINGMODE,{autoPlay:true,loop:true,autoUpdateTexture:true});
gifMat.diffuseTexture=gifTexture;
gifMat.opacityTexture=gifTexture;
gifMat.backFaceCulling=false;
gifPlane.material=gifMat;

// Label pour le GIF
const labelDiv=document.createElement("div");
labelDiv.classList.add("object-label");
labelDiv.textContent=objectLabels[0];
document.body.appendChild(labelDiv);
objectLabelMap.set(gifPlane,labelDiv);

// Clic ouvre la vidéo YouTube
gifPlane.actionManager=new BABYLON.ActionManager(scene);
gifPlane.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, ()=>{
    const videoModal=document.getElementById("videoModal");
    const ytVideo=document.getElementById("ytVideo");
    ytVideo.src="https://www.youtube.com/embed/lUU1G-6klpI?autoplay=1";
    videoModal.style.display="flex";
}));

document.getElementById("closeVideo").addEventListener("click",()=>{
    const videoModal=document.getElementById("videoModal");
    const ytVideo=document.getElementById("ytVideo");
    ytVideo.src="";
    videoModal.style.display="none";
});

// --- Chargement des autres GLB ---
const glbFiles=["IA.glb","labonumerique.glb"];
glbFiles.forEach((file,index)=>{
    BABYLON.SceneLoader.ImportMesh("", "./", file, scene, function(meshes){
        if(!meshes || meshes.length==0) return;
        const mesh=meshes[0];
        mesh.scaling=new BABYLON.Vector3(50,50,50);
        if(file==="labonumerique.glb"){mesh.scaling.scaleInPlace(2.0); mesh.position.y=-60;}
        if(file==="IA.glb") mesh.position.y=-90;
        const pivot=new BABYLON.TransformNode("pivot"+(index+1),scene);
        pivot.rotation.y=(index+1)*angleIncrement;
        mesh.parent=pivot;
        mesh.position.z=radius;
        const label=document.createElement("div");
        label.classList.add("object-label");
        label.textContent=objectLabels[index+1];
        document.body.appendChild(label);
        objectLabelMap.set(mesh,label);
        label.addEventListener("click",()=>{window.location.href=objectLinks[index+1];});
    });
});

// --- Render loop ---
engine.runRenderLoop(()=>{
    scene.render();
    objectLabelMap.forEach((labelDiv,mesh)=>{
        if(!mesh) return;
        const bb=mesh.getBoundingInfo().boundingBox;
        const bottomCenter=new BABYLON.Vector3((bb.minimumWorld.x+bb.maximumWorld.x)/2,bb.minimumWorld.y-10,(bb.minimumWorld.z+bb.maximumWorld.z)/2);
        const pos=BABYLON.Vector3.Project(bottomCenter,BABYLON.Matrix.IdentityReadOnly,scene.getTransformMatrix(),camera.viewport.toGlobal(engine.getRenderWidth(),engine.getRenderHeight()));
        labelDiv.style.visibility=(pos.z>=0 && pos.z<=1)?"visible":"hidden";
        if(pos.z>=0 && pos.z<=1){labelDiv.style.left=pos.x+"px"; labelDiv.style.top=pos.y+"px";}
    });
});
window.addEventListener("resize",()=>engine.resize());

function animateCameraSpin(){
    const initialOffset=-Math.PI/8;
    camera.alpha=Math.PI+initialOffset;
    camera.beta=Math.PI/2;
    camera.radius=450;
    BABYLON.Animation.CreateAndStartAnimation("cameraSpin",camera,"alpha",60,120,camera.alpha,camera.alpha+(2*Math.PI)/3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT,new BABYLON.CubicEase());
    setTimeout(()=>{camera.attachControl(canvas,true); camera.inputs.add(new BABYLON.ArcRotateCameraPointersInput()); camera.inputs.add(new BABYLON.ArcRotateCameraKeyboardInput());},2000);
}

// --- Panorama ---
const panoFile="test7.webp";
createPhotoDome(panoFile);
</script>
</body>
</html>
